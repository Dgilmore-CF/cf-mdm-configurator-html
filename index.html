<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare WARP MDM Configurator</title>
    <style>
        /* --- Base & Typography --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #ffffff;
            color: #1f2937;
            margin: 0;
            line-height: 1.5;
        }
        .container {
            max-width: 1280px;
            margin-left: auto;
            margin-right: auto;
            padding: 1rem;
        }
        @media (min-width: 640px) { .container { padding: 1.5rem; } }
        @media (min-width: 1024px) { .container { padding: 2rem; } }

        h1 { font-size: 1.875rem; font-weight: 700; color: #111827; }
        h2 { font-size: 1.125rem; font-weight: 600; color: #ffffff; margin-bottom: 1rem;}
        p { color: #4b5563; margin-top: 0.5rem; }
        code { background-color: #f3f4f6; color: #F38020; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-family: monospace; }
        a { color: #F97316; text-decoration: none; }
        a:hover { text-decoration: underline; }
        fieldset { border: none; padding: 0; margin: 0; }
        legend { font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 1rem; padding: 0; }
        label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
        
        /* --- Layout --- */
        .grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 1024px) { .grid { grid-template-columns: 1fr 1fr; } }
        .flex-col { display: flex; flex-direction: column; }
        .flex-grow { flex-grow: 1; }

        /* --- Components --- */
        .header, .footer { margin-bottom: 2rem; }
        .footer { margin-top: 3rem; text-align: center; font-size: 0.875rem; color: #6b7281; }
        .disclaimer-box { background-color: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; font-size: 0.875rem; padding: 1rem; margin-bottom: 2rem; border-radius: 0.5rem; }
        .disclaimer-box .font-bold { font-weight: 700; }
        .form-section { background-color: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
        .xml-section { background-color: #1f2937; color: #ffffff; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .xml-preview-container { background-color: #111827; border-radius: 0.375rem; flex-grow: 1; position: relative; }
        .xml-preview {
            width: 100%;
            height: 100%;
            font-family: monospace;
            font-size: 0.875rem;
            color: #6ee7b7;
            padding: 1rem;
            overflow: auto;
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
            box-sizing: border-box; /* <-- FIX: This prevents padding from adding to the width */
        }
        
        /* --- Form Elements --- */
        .form-input, .form-select {
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            padding: 0.5rem 0.75rem;
            color: #111827;
            box-sizing: border-box;
        }
        .form-input:focus, .form-select:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px #fb923c;
        }
        .form-checkbox { height: 1.25rem; width: 1.25rem; border-radius: 0.25rem; border-color: #d1d5db; color: #F97316; }
        .form-checkbox:focus { box-shadow: 0 0 0 2px #fb923c; }
        .checkbox-label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        .input-group { margin-bottom: 1.5rem; }
        .input-description { margin-top: 0.5rem; font-size: 0.75rem; color: #6b7281; }
        .form-divider { border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem; }

        /* --- Buttons --- */
        .button {
            width: 100%;
            color: #ffffff;
            font-weight: 700;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transition: background-color 0.2s;
        }
        .button-primary { background-color: #F38020; }
        .button-primary:hover { background-color: #ea580c; }
        .button-secondary { background-color: #F97316; }
        .button-secondary:hover { background-color: #ea580c; }
        .button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .button-remove { color: #dc2626; font-weight: 600; font-size: 0.875rem; background: none; box-shadow: none; }
        .button-remove:hover { color: #b91c1c; }
        
        /* --- Multi-Org List --- */
        .multi-org-list-container { margin-top: 2rem; }
        .multi-org-list-header { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; border-top: 1px solid #e5e7eb; padding-top: 1rem; }
        .multi-org-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.75rem; }
        .multi-org-list-item { background-color: #ffffff; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .list-item-content { display: flex; align-items: flex-start; justify-content: space-between; }
        .list-item-details .font-bold { font-weight: 700; color: #111827; }
        .list-item-details .font-normal { font-weight: 400; color: #4b5563; }
        .list-item-details p { margin: 0; margin-top: 0.25rem; }
    </style>
</head>
<body>
    <div class="container">
<div id="disclaimer-box" class="disclaimer-box">
            <p><span class="font-bold">Tip:</span> Select your target operating system to see available configuration options.</p>
        </div>
        <header class="header">
            <h1>Cloudflare WARP MDM Configurator</h1>
            <p>
Create a custom MDM configuration file for deploying the Cloudflare WARP client.
            </p>
        </header>

        <div class="grid">
<!-- Form Section -->
            <div class="form-section">
                <div class="input-group">
                    <label for="os-select">Target Operating System</label>
                    <select id="os-select" class="form-select">
                        <option value="windows">Windows</option>
                        <option value="macos">macOS</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="mode-select">Deployment Type</label>
                    <select id="mode-select" class="form-select">
                        <option value="single">Single Organization</option>
                        <option value="multi">Multi-Organization</option>
                    </select>
                </div>
                <div id="form-container" class="form-divider">
                    <!-- Form content will be injected here by JavaScript -->
                </div>
            </div>

            <!-- XML Output and Download Section -->
            <div class="flex-col">
                <div class="xml-section flex-col flex-grow">
                    <h2>Generated mdm.xml</h2>
                    <div class="xml-preview-container">
                        <pre id="xml-output" class="xml-preview"></pre>
                    </div>
                </div>
                 <div style="margin-top: 1.5rem;">
                    <button id="download-button" class="button button-primary">
                        Download MDM.XML
                    </button>
                </div>
            </div>
        </div>
         <footer class="footer">
            <p>This is an unofficial tool. Always verify generated profiles before deploying.</p>
            <p>Refer to the official <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-devices/warp/deployment/mdm-deployment/">Cloudflare Documentation</a> for details.</p>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const paramDocs = {
        organization: "Your organization's team name from the Zero Trust dashboard.",
        displayName: "A user-friendly name for this configuration (e.g., Production).",
        serviceMode: "Sets the client's operational mode.",
        gatewayId: "Your Gateway DoH subdomain. Required for DNS-only policy enforcement.",
        supportUrl: "A URL for users to access for support, like your internal help desk (https:// or mailto:).",
        switchLocked: "If true, users cannot disable the WARP client switch.",
        autoConnect: "The client will automatically reconnect after the specified number of minutes. 0 allows indefinite off state.",
        onboarding: "If disabled, hides onboarding screens that ask users to review the privacy policy.",
        enablePostQuantum: "Enables post-quantum cryptography for the WARP tunnel.",
        overrideEndpoint: "For use with China network partner or third-party partner. Enter the IP address for the respective endpoint.",
        authClientId: "The Client ID of your service token for Service Auth enrollment.",
        authClientSecret: "The Client Secret of your service token for Service Auth enrollment.",
        multiUser: "Enables multiple user registrations on a Windows device. Each Windows user gets their own WARP registration.",
        preLogin: "Allows WARP to connect with a service token before a user completes the initial Windows login.",
        enableNetbt: "Enables NetBIOS over TCP/IP on the WARP tunnel interface (Windows only, disabled by default for security).",
        enablePmtud: "Enables Path MTU Discovery to optimize connection performance.",
        warpTunnelProtocol: "The protocol used to route IP traffic from the device to Cloudflare Gateway.",
        proxyPort: "The localhost SOCKS proxy port when using proxy service mode (0-65535).",
        externalEmergencySignalUrl: "HTTPS endpoint that WARP will poll for an External Emergency Disconnect signal. Must use https:// with an IP address.",
        externalEmergencySignalFingerprint: "SHA-256 fingerprint to validate the external emergency signal HTTPS endpoint.",
        externalEmergencySignalInterval: "How often (in seconds) WARP will poll the external emergency signal URL. Minimum 30, default 300."
    };

    const allFields = [
        { id: 'organization', label: 'Team Name / Organization', placeholder: 'your-team-name', description: paramDocs.organization },
        { id: 'displayName', label: 'Display Name', placeholder: 'Production Environment', description: paramDocs.displayName },
        { id: 'authClientId', label: 'Auth Client ID', placeholder: '88bf3b6d86161464f6509f7219099e57.access', description: paramDocs.authClientId },
        { id: 'authClientSecret', label: 'Auth Client Secret', placeholder: 'bdd31cbc4dec990953e39163fbbb194c...', description: paramDocs.authClientSecret },
        { id: 'serviceMode', label: 'Service Mode', type: 'select', options: [
            { value: 'warp', label: 'Gateway with WARP' },
            { value: '1dot1', label: 'Gateway with DoH' },
            { value: 'proxy', label: 'Proxy Mode' },
            { value: 'tunnelonly', label: 'Secure Web Gateway (no DNS)' },
            { value: 'postureonly', label: 'Device Information Only' }
        ], description: paramDocs.serviceMode },
        { id: 'proxyPort', label: 'Proxy Port', type: 'number', placeholder: '44444', description: paramDocs.proxyPort, showWhen: { field: 'serviceMode', value: 'proxy' } },
        { id: 'gatewayId', label: 'Gateway Unique ID (DoH Subdomain)', placeholder: 'your-doh-subdomain', description: paramDocs.gatewayId },
        { id: 'supportUrl', label: 'Support URL', placeholder: 'https://helpdesk.example.com', description: paramDocs.supportUrl },
        { id: 'autoConnect', label: 'Auto Connect (minutes)', type: 'number', description: paramDocs.autoConnect },
        { id: 'switchLocked', label: 'Lock WARP Switch', type: 'checkbox', description: paramDocs.switchLocked },
        { id: 'onboarding', label: 'Show Onboarding Screens', type: 'checkbox', description: paramDocs.onboarding },
        { id: 'enablePostQuantum', label: 'Enable Post-Quantum Cryptography', type: 'checkbox', description: paramDocs.enablePostQuantum },
        { id: 'warpTunnelProtocol', label: 'Tunnel Protocol', type: 'select', options: [
            { value: 'masque', label: 'MASQUE (default)' },
            { value: 'wireguard', label: 'WireGuard' }
        ], description: paramDocs.warpTunnelProtocol },
        { id: 'enablePmtud', label: 'Enable Path MTU Discovery', type: 'checkbox', description: paramDocs.enablePmtud },
        { id: 'enableNetbt', label: 'Enable NetBIOS over TCP/IP', type: 'checkbox', description: paramDocs.enableNetbt, windowsOnly: true },
    ];

    const chinaFields = [
        { id: 'overrideApiEndpoint', label: 'Override API Endpoint', placeholder: '203.0.113.0', description: paramDocs.overrideEndpoint },
        { id: 'overrideDohEndpoint', label: 'Override DoH Endpoint', placeholder: '203.0.113.0', description: paramDocs.overrideEndpoint },
        { id: 'overrideWarpEndpoint', label: 'Override WARP Endpoint', placeholder: '203.0.113.0:500', description: paramDocs.overrideEndpoint },
    ];

    const emergencyDisconnectFields = [
        { id: 'externalEmergencySignalUrl', label: 'External Emergency Signal URL', placeholder: 'https://192.0.2.1:3333/status/disconnect', description: paramDocs.externalEmergencySignalUrl },
        { id: 'externalEmergencySignalFingerprint', label: 'External Emergency Signal Fingerprint', placeholder: 'DD4F4806C57A5BBAF1AA5B080F0541DA75DB468D0A1FE731310149500CCD8662', description: paramDocs.externalEmergencySignalFingerprint },
        { id: 'externalEmergencySignalInterval', label: 'External Emergency Signal Interval (seconds)', type: 'number', placeholder: '300', description: paramDocs.externalEmergencySignalInterval },
    ];

    const topLevelFields = [
        { id: 'multiUser', label: 'Enable Multi-User Mode', type: 'checkbox', description: paramDocs.multiUser, windowsOnly: true },
        { id: 'preLoginEnabled', label: 'Enable Pre-Login', type: 'checkbox', description: paramDocs.preLogin, windowsOnly: true },
    ];

    const preLoginFields = [
        { id: 'preLoginOrganization', label: 'Pre-Login Organization', placeholder: 'your-team-name', description: 'Organization for pre-login registration.' },
        { id: 'preLoginAuthClientId', label: 'Pre-Login Auth Client ID', placeholder: '88bf3b6d86161464f6509f7219099e57.access', description: 'Service token Client ID for pre-login.' },
        { id: 'preLoginAuthClientSecret', label: 'Pre-Login Auth Client Secret', placeholder: 'bdd31cbc4dec990953e39163fbbb194c...', description: 'Service token Client Secret for pre-login.' },
    ];

    function createFieldHtml(field) {
        const { id, label, type, placeholder, description, options } = field;
        let inputHtml = '';
        if (type === 'select') {
            const optionsHtml = options.map(opt => {
                if (typeof opt === 'object') {
                    return `<option value="${opt.value}">${opt.label}</option>`;
                }
                return `<option value="${opt}">${opt.charAt(0).toUpperCase() + opt.slice(1).replace(/_/g, ' ')}</option>`;
            }).join('');
            inputHtml = `<select id="${id}" class="form-select">${optionsHtml}</select>`;
        } else if (type === 'checkbox') {
            inputHtml = `<label class="checkbox-label"><input id="${id}" type="checkbox" class="form-checkbox" /><span>Enable</span></label>`;
        } else {
            inputHtml = `<input type="${type || 'text'}" id="${id}" placeholder="${placeholder || ''}" class="form-input" />`;
        }
        return `<div class="input-group"><label for="${id}">${label}</label>${inputHtml}${description ? `<p class="input-description">${description}</p>` : ''}</div>`;
    }

    // --- STATE MANAGEMENT ---
    const initialConfigState = {
        organization: '', serviceMode: 'warp', gatewayId: '', supportUrl: '', switchLocked: true, autoConnect: 0,
        onboarding: true, enablePostQuantum: false, enablePmtud: false, enableNetbt: false, warpTunnelProtocol: 'masque', proxyPort: 0,
        overrideApiEndpoint: '', overrideDohEndpoint: '', overrideWarpEndpoint: '', authClientId: '', authClientSecret: '', displayName: '',
        externalEmergencySignalUrl: '', externalEmergencySignalFingerprint: '', externalEmergencySignalInterval: 0
    };

    const initialTopLevelState = {
        multiUser: false,
        preLoginEnabled: false,
        preLoginOrganization: '',
        preLoginAuthClientId: '',
        preLoginAuthClientSecret: ''
    };
    
    let appState = {
        os: 'windows',
        mode: 'single',
        singleOrgConfig: { ...initialConfigState },
        multiOrgConfigs: [],
        newMultiOrgConfig: { ...initialConfigState },
        topLevel: { ...initialTopLevelState }
    };

    // --- DOM REFERENCES ---
    const osSelect = document.getElementById('os-select');
    const modeSelect = document.getElementById('mode-select');
    const formContainer = document.getElementById('form-container');
    const xmlOutputEl = document.getElementById('xml-output');
    const downloadButton = document.getElementById('download-button');

    // --- RENDER/UPDATE FUNCTIONS ---
    function filterFieldsByOs(fields) {
        return fields.filter(f => !f.windowsOnly || appState.os === 'windows');
    }

    function render() {
        formContainer.innerHTML = ''; // Clear previous form
        const isWindows = appState.os === 'windows';
        
        let topLevelHtml = filterFieldsByOs(topLevelFields).map(createFieldHtml).join('');
        let preLoginHtml = preLoginFields.map(createFieldHtml).join('');
        let emergencyHtml = emergencyDisconnectFields.map(createFieldHtml).join('');
        let chinaFormFields = chinaFields.map(createFieldHtml).join('');

        // Windows-only top-level section
        const windowsFeaturesSection = isWindows ? `
            <fieldset id="top-level-fieldset">
                <legend>Windows Features (Top-Level)</legend>
                ${topLevelHtml}
                <div id="pre-login-fields" style="display: none;">
                    ${preLoginHtml}
                </div>
            </fieldset>` : '';

        if (appState.mode === 'single') {
            let singleFormFields = filterFieldsByOs(allFields).filter(f => !f.multiOnly).map(createFieldHtml).join('');
            formContainer.innerHTML = `
                ${windowsFeaturesSection}
                <fieldset id="single-org-fieldset" class="${isWindows ? 'form-divider' : ''}">
                    <legend>Organization Settings</legend>
                    ${singleFormFields}
                    <fieldset class="form-divider">
                        <legend>External Emergency Disconnect (Optional)</legend>
                        ${emergencyHtml}
                    </fieldset>
                    <fieldset class="form-divider">
                        <legend>Endpoint Overrides (Optional)</legend>
                        ${chinaFormFields}
                    </fieldset>
                </fieldset>`;
            updateSingleFormValues();
            if (isWindows) updateTopLevelFormValues();
        } else {
            let multiFormFields = filterFieldsByOs(allFields).map(createFieldHtml).join('');
            formContainer.innerHTML = `
                ${windowsFeaturesSection}
                <form id="multi-org-form" class="${isWindows ? 'form-divider' : ''}">
                    <fieldset>
                        <legend>Add Organization Configuration</legend>
                        ${multiFormFields}
                        <fieldset class="form-divider">
                            <legend>External Emergency Disconnect (Optional)</legend>
                            ${emergencyHtml}
                        </fieldset>
                        <fieldset class="form-divider">
                            <legend>Endpoint Overrides (Optional)</legend>
                            ${chinaFormFields}
                        </fieldset>
                        <button type="submit" class="button button-secondary" style="margin-top: 1.5rem;">Add Organization Configuration</button>
                    </fieldset>
                </form>
                <div id="multi-org-list-container"></div>`;
            updateMultiOrgList();
            updateNewMultiFormValues();
            if (isWindows) updateTopLevelFormValues();
        }
        addEventListeners();
        if (isWindows) togglePreLoginFields();
        updateDownloadButton();
        generateXml();
    }

    function togglePreLoginFields() {
        const preLoginFieldsDiv = document.getElementById('pre-login-fields');
        if (preLoginFieldsDiv) {
            preLoginFieldsDiv.style.display = appState.topLevel.preLoginEnabled ? 'block' : 'none';
        }
    }

    function addEventListeners() {
        // Top-level fields event listeners
        document.querySelectorAll('#top-level-fieldset input, #top-level-fieldset select').forEach(el => {
            const eventType = el.type === 'checkbox' ? 'change' : 'input';
            el.addEventListener(eventType, (e) => {
                const { id, value, type, checked } = e.target;
                appState.topLevel[id] = type === 'checkbox' ? checked : (type === 'number' ? Number(value) : value);
                if (id === 'preLoginEnabled') {
                    togglePreLoginFields();
                }
                generateXml();
            });
        });

        if (appState.mode === 'single') {
            document.querySelectorAll('#single-org-fieldset input, #single-org-fieldset select').forEach(el => {
                const eventType = el.type === 'checkbox' ? 'change' : 'input';
                el.addEventListener(eventType, (e) => {
                    const { id, value, type, checked } = e.target;
                    appState.singleOrgConfig[id] = type === 'checkbox' ? checked : (type === 'number' ? Number(value) : value);
                    generateXml();
                });
            });
        } else {
            document.getElementById('multi-org-form').addEventListener('submit', handleAddMultiOrg);
            document.querySelectorAll('#multi-org-form input, #multi-org-form select').forEach(el => {
                 const eventType = el.type === 'checkbox' ? 'change' : 'input';
                el.addEventListener(eventType, (e) => {
                    const { id, value, type, checked } = e.target;
                    appState.newMultiOrgConfig[id] = type === 'checkbox' ? checked : (type === 'number' ? Number(value) : value);
                });
            });
        }
    }

    function updateSingleFormValues() {
        for (const key in appState.singleOrgConfig) {
            const el = document.getElementById(key);
            if (el) {
                if (el.type === 'checkbox') el.checked = appState.singleOrgConfig[key];
                else el.value = appState.singleOrgConfig[key];
            }
        }
    }

    function updateTopLevelFormValues() {
        for (const key in appState.topLevel) {
            const el = document.getElementById(key);
            if (el) {
                if (el.type === 'checkbox') el.checked = appState.topLevel[key];
                else el.value = appState.topLevel[key];
            }
        }
    }
    
    function updateNewMultiFormValues() {
        for (const key in appState.newMultiOrgConfig) {
            const el = document.getElementById(key);
            if (el) {
                if (el.type === 'checkbox') el.checked = appState.newMultiOrgConfig[key];
                else el.value = appState.newMultiOrgConfig[key];
            }
        }
    }

    function updateMultiOrgList() {
        const container = document.getElementById('multi-org-list-container');
        if (!container) return;
        if (appState.multiOrgConfigs.length === 0) {
            container.innerHTML = '';
            return;
        }
        container.innerHTML = `
            <h3 class="multi-org-list-header">Current Configurations:</h3>
            <ul class="multi-org-list">
                ${appState.multiOrgConfigs.map((config, index) => `
                    <li class="multi-org-list-item">
                        <div class="list-item-content">
                            <div class="list-item-details">
                                <p><span class="font-bold">${config.displayName}</span> <span class="font-normal">(${config.organization})</span></p>
                                <p>Mode: ${config.serviceMode}, Gateway: ${config.gatewayId || 'Default'}</p>
                            </div>
                            <button data-index="${index}" class="button-remove">Remove</button>
                        </div>
                    </li>
                `).join('')}
            </ul>`;
        document.querySelectorAll('.button-remove').forEach(btn => btn.addEventListener('click', handleRemoveMultiOrg));
    }

    function handleAddMultiOrg(e) {
        e.preventDefault();
        const { organization, displayName } = appState.newMultiOrgConfig;
        if (organization && displayName) {
            appState.multiOrgConfigs.push({ ...appState.newMultiOrgConfig });
            appState.newMultiOrgConfig = { ...initialConfigState };
            updateMultiOrgList();
            updateNewMultiFormValues();
            generateXml();
        }
    }

    function handleRemoveMultiOrg(e) {
        const index = parseInt(e.target.dataset.index, 10);
        appState.multiOrgConfigs.splice(index, 1);
        updateMultiOrgList();
        generateXml();
    }

    function generateXml() {
        let xmlString = '';
        const escapeXml = (unsafe) => unsafe.replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&apos;','"':'&quot;'}[c]));

        const formatSimpleArray = (input) => {
            if (!input || !input.trim()) return null;
            const items = input.split(',').map(item => `        <string>${escapeXml(item.trim())}</string>`).join('\n');
            return `    <array>\n${items}\n    </array>`;
        };
        
        const generateDictItems = (config) => {
            const isWindows = appState.os === 'windows';
            const items = [
                { key: 'organization', value: config.organization, type: 'string' },
                { key: 'display_name', value: config.displayName, type: 'string' },
                { key: 'gateway_unique_id', value: config.gatewayId, type: 'string' },
                { key: 'auth_client_id', value: config.authClientId, type: 'string' },
                { key: 'auth_client_secret', value: config.authClientSecret, type: 'string' },
                { key: 'service_mode', value: config.serviceMode, type: 'string' },
                { key: 'proxy_port', value: config.serviceMode === 'proxy' && config.proxyPort ? config.proxyPort : null, type: 'integer' },
                { key: 'support_url', value: config.supportUrl, type: 'string' },
                { key: 'switch_locked', value: config.switchLocked, type: 'boolean' },
                { key: 'auto_connect', value: config.autoConnect, type: 'integer' },
                { key: 'onboarding', value: config.onboarding, type: 'boolean' },
                { key: 'enable_post_quantum', value: config.enablePostQuantum, type: 'boolean' },
                { key: 'warp_tunnel_protocol', value: config.warpTunnelProtocol !== 'masque' ? config.warpTunnelProtocol : null, type: 'string' },
                { key: 'enable_pmtud', value: config.enablePmtud, type: 'boolean' },
                { key: 'enable_netbt', value: isWindows ? config.enableNetbt : null, type: 'boolean', windowsOnly: true },
                { key: 'external_emergency_signal_url', value: config.externalEmergencySignalUrl, type: 'string' },
                { key: 'external_emergency_signal_fingerprint', value: config.externalEmergencySignalFingerprint, type: 'string' },
                { key: 'external_emergency_signal_interval', value: config.externalEmergencySignalInterval > 0 ? config.externalEmergencySignalInterval : null, type: 'integer' },
                { key: 'override_api_endpoint', value: config.overrideApiEndpoint, type: 'string' },
                { key: 'override_doh_endpoint', value: config.overrideDohEndpoint, type: 'string' },
                { key: 'override_warp_endpoint', value: config.overrideWarpEndpoint, type: 'string' },
            ];
            return items.filter(item => {
                if (item.windowsOnly && !isWindows) return false;
                if (item.value === null || item.value === undefined) return false;
                if (typeof item.value === 'string' && item.value.trim() === '') return false;
                if (item.key === 'auto_connect') return true;
                if (item.type === 'boolean' && item.value === false) {
                    const keysToKeepWhenFalse = ['switch_locked', 'onboarding', 'enable_post_quantum', 'enable_pmtud', 'enable_netbt'];
                    return keysToKeepWhenFalse.includes(item.key);
                }
                return true;
            });
        };

        const needsConfigsWrapper = () => {
            const isWindows = appState.os === 'windows';
            // Windows-only top-level features require configs wrapper
            const hasWindowsFeatures = isWindows && (appState.topLevel.multiUser || appState.topLevel.preLoginEnabled);
            return hasWindowsFeatures || appState.mode === 'multi';
        };

        const formatValueTag = (item, indent) => {
            switch (item.type) {
                case 'string': return `${indent}<string>${escapeXml(item.value)}</string>`;
                case 'integer': return `${indent}<integer>${item.value}</integer>`;
                case 'boolean': return `${indent}${item.value ? '<true/>' : '<false/>'}`;
                default: return '';
            }
        };

        const generatePreLoginDict = (indent) => {
            const tl = appState.topLevel;
            if (!tl.preLoginEnabled || !tl.preLoginOrganization) return '';
            let items = [];
            items.push(`${indent}  <key>organization</key>\n${indent}  <string>${escapeXml(tl.preLoginOrganization)}</string>`);
            if (tl.preLoginAuthClientId) {
                items.push(`${indent}  <key>auth_client_id</key>\n${indent}  <string>${escapeXml(tl.preLoginAuthClientId)}</string>`);
            }
            if (tl.preLoginAuthClientSecret) {
                items.push(`${indent}  <key>auth_client_secret</key>\n${indent}  <string>${escapeXml(tl.preLoginAuthClientSecret)}</string>`);
            }
            return `${indent}<key>pre_login</key>\n${indent}<dict>\n${items.join('\n')}\n${indent}</dict>`;
        };

        if (appState.mode === 'single') {
            if (!appState.singleOrgConfig.organization) {
                xmlString = '<!-- Enter an Organization Name to generate the XML file. -->';
            } else if (needsConfigsWrapper()) {
                // Single org but with multi_user or pre_login - needs configs array wrapper
                let topLevelItems = [];
                if (appState.topLevel.multiUser) {
                    topLevelItems.push('  <key>multi_user</key>\n  <true/>');
                }
                if (appState.topLevel.preLoginEnabled && appState.topLevel.preLoginOrganization) {
                    topLevelItems.push(generatePreLoginDict('  '));
                }
                
                const dictItems = generateDictItems(appState.singleOrgConfig).map(item => {
                    return `      <key>${item.key}</key>\n${formatValueTag(item, '      ')}`;
                }).join('\n');
                
                topLevelItems.push(`  <key>configs</key>\n  <array>\n    <dict>\n${dictItems}\n    </dict>\n  </array>`);
                
                xmlString = `<?xml version="1.0" encoding="UTF-8"?>\n<dict>\n${topLevelItems.join('\n')}\n</dict>`;
            } else {
                // Simple single org without top-level features
                const dictItems = generateDictItems(appState.singleOrgConfig).map(item => {
                    return `  <key>${item.key}</key>\n${formatValueTag(item, '  ')}`;
                }).join('\n');
                xmlString = `<?xml version="1.0" encoding="UTF-8"?>\n<dict>\n${dictItems}\n</dict>`;
            }
        } else {
            if (appState.multiOrgConfigs.length === 0) {
                 xmlString = '<!-- Add an organization configuration to generate the XML file. -->';
            } else {
                let topLevelItems = [];
                if (appState.topLevel.multiUser) {
                    topLevelItems.push('  <key>multi_user</key>\n  <true/>');
                }
                if (appState.topLevel.preLoginEnabled && appState.topLevel.preLoginOrganization) {
                    topLevelItems.push(generatePreLoginDict('  '));
                }
                
                const configDicts = appState.multiOrgConfigs.map(config => {
                    const items = generateDictItems(config).map(item => {
                        return `      <key>${item.key}</key>\n${formatValueTag(item, '      ')}`;
                    }).join('\n');
                    return `    <dict>\n${items}\n    </dict>`;
                }).join('\n');
                
                topLevelItems.push(`  <key>configs</key>\n  <array>\n${configDicts}\n  </array>`);
                
                xmlString = `<?xml version="1.0" encoding="UTF-8"?>\n<dict>\n${topLevelItems.join('\n')}\n</dict>`;
            }
        }

        xmlOutputEl.textContent = xmlString;
        downloadButton.disabled = xmlString.startsWith('<!--');
    }

    function updateDownloadButton() {
        const filename = appState.os === 'macos' ? 'mdm.xml' : 'mdm.xml';
        downloadButton.textContent = `Download ${filename.toUpperCase()}`;
    }

    // --- INITIALIZATION ---
    osSelect.addEventListener('change', (e) => {
        appState.os = e.target.value;
        // Reset Windows-only top-level settings when switching to macOS
        if (appState.os === 'macos') {
            appState.topLevel.multiUser = false;
            appState.topLevel.preLoginEnabled = false;
        }
        render();
    });

    modeSelect.addEventListener('change', (e) => {
        appState.mode = e.target.value;
        render();
    });

    downloadButton.addEventListener('click', () => {
        const blob = new Blob([xmlOutputEl.textContent], { type: 'application/xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'mdm.xml'; // Same filename for both platforms
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    render(); // Initial render
});
</script>

</body>
</html>
