<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare WARP MDM Configurator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A little extra style for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://rsms.me/inter/inter.css');
    </style>
</head>
<body class="bg-white min-h-screen font-sans text-gray-900">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-blue-50 border border-blue-200 text-blue-800 text-sm p-4 mb-8 rounded-lg" role="alert">
            <p><span class="font-bold">Note:</span> This tool currently only supports Windows deployments.</p>
        </div>
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Cloudflare WARP MDM Configurator</h1>
            <p class="text-gray-600 mt-2">
                Create a custom <code class="bg-gray-200 text-[#F38020] px-1 py-0.5 rounded">mdm.xml</code> file for deploying the WARP client.
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Form Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="mb-6">
                    <label for="mode-select" class="block text-sm font-medium text-gray-700 mb-1">Deployment Type</label>
                    <select id="mode-select" class="w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="single">Single Organization</option>
                        <option value="multi">Multi-Organization</option>
                    </select>
                </div>
                <div id="form-container" class="border-t border-gray-200 pt-4">
                    <!-- Form content will be injected here by JavaScript -->
                </div>
            </div>

            <!-- XML Output and Download Section -->
            <div class="flex flex-col">
                <div class="bg-gray-800 text-white p-6 rounded-lg shadow-lg flex-grow flex flex-col">
                    <h2 class="text-lg font-semibold text-white mb-4">Generated mdm.xml</h2>
                    <div class="bg-gray-900 rounded-md flex-grow relative">
                        <pre class="w-full h-full text-sm text-cyan-300 p-4 overflow-auto absolute inset-0"><code id="xml-output"></code></pre>
                    </div>
                </div>
                 <div class="mt-6">
                    <button id="download-button" class="w-full bg-[#F38020] hover:bg-orange-600 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors duration-200">
                        Download MDM.XML
                    </button>
                </div>
            </div>
        </div>
         <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>This is an unofficial tool. Always verify generated profiles before deploying.</p>
            <p>Refer to the official <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-devices/warp/deployment/mdm-deployment/" target="_blank" rel="noopener noreferrer" class="text-orange-500 hover:underline">Cloudflare Documentation</a> for details.</p>
        </footer>
    </div>

<script>
    // --- TEMPLATES FOR FORMS ---
    const singleOrgFormTemplate = `
        <fieldset id="single-org-fieldset">
            <legend class="text-lg font-semibold text-gray-900 mb-4">Single Organization Settings</legend>
            <!-- All input fields will be here -->
        </fieldset>
    `;

    const multiOrgFormTemplate = `
        <form id="multi-org-form">
            <fieldset>
                <legend class="text-lg font-semibold text-gray-900 mb-4">Add Organization Configuration</legend>
                <!-- Inputs for a new multi-org config -->
                <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 mt-6">Add Additional Organization Configuration</button>
            </fieldset>
        </form>
        <div id="multi-org-list-container" class="mt-8"></div>
    `;

    const paramDocs = {
        organization: "Your organization's team name from the Zero Trust dashboard.",
        displayName: "A user-friendly name for this configuration (e.g., Production).",
        serviceMode: "Sets the client's operational mode.",
        gatewayId: "Your Gateway unique ID. If you do not include this, the client will use the default Gateway configuration.",
        supportUrl: "A URL for users to access for support, like your internal help desk.",
        switchLocked: "If true, users cannot disable the WARP client switch.",
        autoConnect: "The client will attempt to connect every X minutes. 0 means it is disabled.",
        allowUpdates: "If true, the Cloudflare WARP client will automatically update.",
        dnsServers: "A comma-separated list of IP addresses to be used for DNS over HTTPS.",
        splitTunnelInclude: "A comma-separated list of IPs and domains to be included in the WARP tunnel.",
        splitTunnelExclude: "A comma-separated list of IPs and domains to be excluded from the WARP tunnel.",
        onboarding: "If enabled, prevents the onboarding screens from showing to new users.",
        localDomainFallback: "Comma-separated list of domains to resolve via local DNS. E.g., example.com,*.internal.corp",
        captivePortal: "Enable captive portal detection. Recommended to keep enabled.",
        modeSwitchLocked: "If enabled, users cannot switch between service modes (e.g., WARP to Proxy).",
        enableDex: "Enables Digital Experience Monitoring.",
        enablePostQuantum: "Enables support for post-quantum cryptography.",
        overrideEndpoint: "For use in China only. Enter the IP address for the respective endpoint.",
        authClientId: "The Client ID of your service token.",
        authClientSecret: "The Client Secret of your service token."
    };

    const allFields = [
        { id: 'organization', label: 'Team Name / Organization', placeholder: 'your-team-name', description: paramDocs.organization },
        { id: 'displayName', label: 'Display Name', placeholder: 'Production Environment', description: paramDocs.displayName, multiOnly: true },
        { id: 'authClientId', label: 'Auth Client ID', placeholder: 'Service Token Client ID', description: paramDocs.authClientId },
        { id: 'authClientSecret', label: 'Auth Client Secret', placeholder: 'Service Token Client Secret', description: paramDocs.authClientSecret },
        { id: 'serviceMode', label: 'Service Mode', type: 'select', options: ['warp', 'proxy', 'tunnel_only', 'posture_only'], description: paramDocs.serviceMode },
        { id: 'gatewayId', label: 'Gateway Unique ID', placeholder: 'your-gateway-id', description: paramDocs.gatewayId },
        { id: 'supportUrl', label: 'Support URL', placeholder: 'https://helpdesk.example.com', description: paramDocs.supportUrl },
        { id: 'autoConnect', label: 'Auto Connect (minutes)', type: 'number', description: paramDocs.autoConnect },
        { id: 'switchLocked', label: 'Lock WARP Switch', type: 'checkbox', description: paramDocs.switchLocked },
        { id: 'modeSwitchLocked', label: 'Lock Service Mode Switch', type: 'checkbox', description: paramDocs.modeSwitchLocked },
        { id: 'allowUpdates', label: 'Allow Auto Updates', type: 'checkbox', description: paramDocs.allowUpdates },
        { id: 'onboarding', label: 'Disable Onboarding Flow', type: 'checkbox', description: paramDocs.onboarding },
        { id: 'captivePortal', label: 'Captive Portal Detection', type: 'checkbox', description: paramDocs.captivePortal },
        { id: 'enableDex', label: 'Enable Digital Experience Monitoring', type: 'checkbox', description: paramDocs.enableDex },
        { id: 'enablePostQuantum', label: 'Enable Post-Quantum Cryptography', type: 'checkbox', description: paramDocs.enablePostQuantum },
        { id: 'dnsServers', label: 'DNS Servers', placeholder: '1.1.1.1, 8.8.8.8', description: paramDocs.dnsServers },
        { id: 'splitTunnelInclude', label: 'Split Tunnel - Include', placeholder: '192.168.1.0/24, example.com', description: paramDocs.splitTunnelInclude },
        { id: 'splitTunnelExclude', label: 'Split Tunnel - Exclude', placeholder: '10.0.0.0/8', description: paramDocs.splitTunnelExclude },
        { id: 'localDomainFallback', label: 'Local Domain Fallback', placeholder: 'example.com,*.internal.corp', description: paramDocs.localDomainFallback },
    ];

    const chinaFields = [
        { id: 'overrideApiEndpoint', label: 'Override API Endpoint', placeholder: '203.0.113.0', description: paramDocs.overrideEndpoint },
        { id: 'overrideDohEndpoint', label: 'Override DoH Endpoint', placeholder: '203.0.113.0', description: paramDocs.overrideEndpoint },
        { id: 'overrideWarpEndpoint', label: 'Override WARP Endpoint', placeholder: '203.0.113.0:0', description: paramDocs.overrideEndpoint },
    ];

    function createFieldHtml(field) {
        const { id, label, type, placeholder, description, options } = field;
        let inputHtml = '';
        if (type === 'select') {
            const optionsHtml = options.map(opt => `<option value="${opt}">${opt.charAt(0).toUpperCase() + opt.slice(1).replace('_', ' ')}</option>`).join('');
            inputHtml = `<select id="${id}" class="w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">${optionsHtml}</select>`;
        } else if (type === 'checkbox') {
            inputHtml = `<label class="flex items-center space-x-3 cursor-pointer"><input id="${id}" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-orange-500 focus:ring-orange-500" /><span class="text-gray-700">Enable</span></label>`;
        } else {
            inputHtml = `<input type="${type || 'text'}" id="${id}" placeholder="${placeholder || ''}" class="w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" />`;
        }
        return `<div class="mb-6"><label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>${inputHtml}${description ? `<p class="mt-2 text-xs text-gray-500">${description}</p>` : ''}</div>`;
    }

    // --- STATE MANAGEMENT ---
    let appState = {
        mode: 'single',
        singleOrgConfig: {
            organization: '', serviceMode: 'warp', gatewayId: '', supportUrl: '', switchLocked: true, autoConnect: 0, allowUpdates: true, dnsServers: '',
            splitTunnelInclude: '', splitTunnelExclude: '', onboarding: false, localDomainFallback: '', captivePortal: true, modeSwitchLocked: true,
            enableDex: true, enablePostQuantum: false, overrideApiEndpoint: '', overrideDohEndpoint: '', overrideWarpEndpoint: '', authClientId: '', authClientSecret: ''
        },
        multiOrgConfigs: [],
        newMultiOrgConfig: {
            organization: '', displayName: '', serviceMode: 'warp', gatewayId: '', supportUrl: '', switchLocked: true, autoConnect: 0, allowUpdates: true, dnsServers: '',
            splitTunnelInclude: '', splitTunnelExclude: '', onboarding: false, localDomainFallback: '', captivePortal: true, modeSwitchLocked: true,
            enableDex: true, enablePostQuantum: false, overrideApiEndpoint: '', overrideDohEndpoint: '', overrideWarpEndpoint: '', authClientId: '', authClientSecret: ''
        }
    };

    // --- DOM REFERENCES ---
    const modeSelect = document.getElementById('mode-select');
    const formContainer = document.getElementById('form-container');
    const xmlOutputEl = document.getElementById('xml-output');
    const downloadButton = document.getElementById('download-button');

    // --- RENDER/UPDATE FUNCTIONS ---
    function render() {
        formContainer.innerHTML = ''; // Clear previous form
        if (appState.mode === 'single') {
            let singleFormFields = allFields.filter(f => !f.multiOnly).map(createFieldHtml).join('');
            let chinaFormFields = chinaFields.map(createFieldHtml).join('');
            formContainer.innerHTML = `
                <fieldset id="single-org-fieldset">
                    <legend class="text-lg font-semibold text-gray-900 mb-4">Single Organization Settings</legend>
                    ${singleFormFields}
                    <fieldset class="mt-8 border-t border-gray-200 pt-4">
                        <legend class="text-md font-semibold text-gray-800 mb-2">China Network Overrides (Optional)</legend>
                        ${chinaFormFields}
                    </fieldset>
                </fieldset>`;
            updateSingleFormValues();
        } else {
            let multiFormFields = allFields.map(createFieldHtml).join('');
            let chinaFormFields = chinaFields.map(createFieldHtml).join('');
            formContainer.innerHTML = `
                <form id="multi-org-form">
                    <fieldset>
                        <legend class="text-lg font-semibold text-gray-900 mb-4">Add Organization Configuration</legend>
                        ${multiFormFields}
                         <fieldset class="mt-8 border-t border-gray-200 pt-4">
                            <legend class="text-md font-semibold text-gray-800 mb-2">China Network Overrides (Optional)</legend>
                            ${chinaFormFields}
                        </fieldset>
                        <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 mt-6">Add Additional Organization Configuration</button>
                    </fieldset>
                </form>
                <div id="multi-org-list-container" class="mt-8"></div>`;
            updateMultiOrgList();
            updateNewMultiFormValues();
        }
        addEventListeners();
        generateXml();
    }

    function addEventListeners() {
        if (appState.mode === 'single') {
            document.querySelectorAll('#single-org-fieldset input, #single-org-fieldset select').forEach(el => {
                const eventType = el.type === 'checkbox' ? 'change' : 'input';
                el.addEventListener(eventType, (e) => {
                    const { id, value, type, checked } = e.target;
                    appState.singleOrgConfig[id] = type === 'checkbox' ? checked : (type === 'number' ? Number(value) : value);
                    generateXml();
                });
            });
        } else {
            document.getElementById('multi-org-form').addEventListener('submit', handleAddMultiOrg);
            document.querySelectorAll('#multi-org-form input, #multi-org-form select').forEach(el => {
                 const eventType = el.type === 'checkbox' ? 'change' : 'input';
                el.addEventListener(eventType, (e) => {
                    const { id, value, type, checked } = e.target;
                    appState.newMultiOrgConfig[id] = type === 'checkbox' ? checked : (type === 'number' ? Number(value) : value);
                });
            });
        }
    }

    function updateSingleFormValues() {
        for (const key in appState.singleOrgConfig) {
            const el = document.getElementById(key);
            if (el) {
                if (el.type === 'checkbox') el.checked = appState.singleOrgConfig[key];
                else el.value = appState.singleOrgConfig[key];
            }
        }
    }
    
    function updateNewMultiFormValues() {
        for (const key in appState.newMultiOrgConfig) {
            const el = document.getElementById(key);
            if (el) {
                if (el.type === 'checkbox') el.checked = appState.newMultiOrgConfig[key];
                else el.value = appState.newMultiOrgConfig[key];
            }
        }
    }

    function updateMultiOrgList() {
        const container = document.getElementById('multi-org-list-container');
        if (!container) return;
        if (appState.multiOrgConfigs.length === 0) {
            container.innerHTML = '';
            return;
        }
        container.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-t border-gray-200 pt-4">Current Configurations:</h3>
            <ul class="space-y-3">
                ${appState.multiOrgConfigs.map((config, index) => `
                    <li class="bg-white border border-gray-200 p-4 rounded-md shadow-sm">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="font-bold text-gray-900">${config.displayName} <span class="font-normal text-gray-600">(${config.organization})</span></p>
                                <p class="text-sm text-gray-500 mt-1">Mode: ${config.serviceMode}, Gateway: ${config.gatewayId || 'Default'}</p>
                            </div>
                            <button data-index="${index}" class="remove-btn text-red-600 hover:text-red-500 font-semibold text-sm ml-4 flex-shrink-0">Remove</button>
                        </div>
                    </li>
                `).join('')}
            </ul>`;
        document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', handleRemoveMultiOrg));
    }

    function handleAddMultiOrg(e) {
        e.preventDefault();
        const { organization, displayName } = appState.newMultiOrgConfig;
        if (organization && displayName) {
            appState.multiOrgConfigs.push({ ...appState.newMultiOrgConfig });
            // Reset the new config form state
            appState.newMultiOrgConfig = {
                organization: '', displayName: '', serviceMode: 'warp', gatewayId: '', supportUrl: '', switchLocked: true, autoConnect: 0, allowUpdates: true, dnsServers: '',
                splitTunnelInclude: '', splitTunnelExclude: '', onboarding: false, localDomainFallback: '', captivePortal: true, modeSwitchLocked: true,
                enableDex: true, enablePostQuantum: false, overrideApiEndpoint: '', overrideDohEndpoint: '', overrideWarpEndpoint: '', authClientId: '', authClientSecret: ''
            };
            updateMultiOrgList();
            updateNewMultiFormValues();
            generateXml();
        }
    }

    function handleRemoveMultiOrg(e) {
        const index = parseInt(e.target.dataset.index, 10);
        appState.multiOrgConfigs.splice(index, 1);
        updateMultiOrgList();
        generateXml();
    }

    function generateXml() {
        let xmlString = '';
        const formatSimpleArray = (input) => {
            if (!input || !input.trim()) return null;
            const items = input.split(',').map(item => `        <string>${item.trim()}</string>`).join('\n');
            return `    <array>\n${items}\n    </array>`;
        };
        
        const generateDictItems = (config) => {
             const items = [
                { key: 'organization', value: config.organization, type: 'string' },
                { key: 'display_name', value: config.displayName, type: 'string' },
                { key: 'service_mode', value: config.serviceMode, type: 'string' },
                { key: 'gateway_id', value: config.gatewayId, type: 'string' },
                { key: 'auth_client_id', value: config.authClientId, type: 'string' },
                { key: 'auth_client_secret', value: config.authClientSecret, type: 'string' },
                { key: 'support_url', value: config.supportUrl, type: 'string' },
                { key: 'switch_locked', value: config.switchLocked, type: 'boolean' },
                { key: 'mode_switch_locked', value: config.modeSwitchLocked, type: 'boolean' },
                { key: 'auto_connect', value: config.autoConnect, type: 'integer' },
                { key: 'allow_updates', value: config.allowUpdates, type: 'boolean' },
                { key: 'onboarding', value: config.onboarding, type: 'boolean' },
                { key: 'captive_portal', value: config.captivePortal, type: 'boolean' },
                { key: 'enable_dex', value: config.enableDex, type: 'boolean' },
                { key: 'enable_post_quantum', value: config.enablePostQuantum, type: 'boolean' },
                { key: 'dns_servers', value: formatSimpleArray(config.dnsServers), type: 'array' },
                { key: 'split_tunnel_include', value: formatSimpleArray(config.splitTunnelInclude), type: 'array' },
                { key: 'split_tunnel_exclude', value: formatSimpleArray(config.splitTunnelExclude), type: 'array' },
                { key: 'local_domain_fallback', value: formatSimpleArray(config.localDomainFallback), type: 'array' },
                { key: 'override_api_endpoint', value: config.overrideApiEndpoint, type: 'string' },
                { key: 'override_doh_endpoint', value: config.overrideDohEndpoint, type: 'string' },
                { key: 'override_warp_endpoint', value: config.overrideWarpEndpoint, type: 'string' },
            ];
            return items.filter(item => {
                if (item.value === null || item.value === undefined) return false;
                if (typeof item.value === 'string' && item.value.trim() === '') return false;
                if (item.key === 'auto_connect') return true;
                if (item.type === 'boolean' && item.value === false) {
                    const keysToKeepWhenFalse = ['switch_locked', 'mode_switch_locked', 'allow_updates', 'onboarding', 'captive_portal', 'enable_dex', 'enable_post_quantum'];
                    return keysToKeepWhenFalse.includes(item.key);
                }
                return true;
            });
        };

        if (appState.mode === 'single') {
            if (!appState.singleOrgConfig.organization) {
                xmlString = '<!-- Enter an Organization Name to generate the XML file. -->';
            } else {
                const dictItems = generateDictItems(appState.singleOrgConfig).map(item => {
                    let valueTag;
                    switch (item.type) {
                        case 'string': valueTag = `    <string>${item.value}</string>`; break;
                        case 'integer': valueTag = `    <integer>${item.value}</integer>`; break;
                        case 'boolean': valueTag = `    ${item.value ? '<true/>' : '<false/>'}`; break;
                        case 'array': valueTag = item.value; break;
                        default: valueTag = '';
                    }
                    return `    <key>${item.key}</key>\n${valueTag}`;
                }).join('\n');
                xmlString = `<?xml version="1.0" encoding="UTF-8"?>\n<dict>\n${dictItems}\n</dict>`;
            }
        } else {
            if (appState.multiOrgConfigs.length === 0) {
                 xmlString = '<!-- Add an organization configuration to generate the XML file. -->';
            } else {
                const configDicts = appState.multiOrgConfigs.map(config => {
                    const items = generateDictItems(config).map(item => {
                         let valueTag;
                        switch (item.type) {
                            case 'string': valueTag = `      <string>${item.value}</string>`; break;
                            case 'integer': valueTag = `      <integer>${item.value}</integer>`; break;
                            case 'boolean': valueTag = `      ${item.value ? '<true/>' : '<false/>'}`; break;
                            case 'array': valueTag = item.value; break; // This needs adjustment for indentation
                            default: valueTag = '';
                        }
                        // Adjust indentation for arrays within multi-org
                        if (item.type === 'array') {
                            valueTag = valueTag.replace(/    /g, '      ').replace(/      <string>/g, '        <string>');
                        }
                        return `      <key>${item.key}</key>\n${valueTag}`;
                    }).join('\n');
                    return `    <dict>\n${items}\n    </dict>`;
                }).join('\n');
                xmlString = `<?xml version="1.0" encoding="UTF-8"?>\n<dict>\n  <key>configs</key>\n  <array>\n${configDicts}\n  </array>\n</dict>`;
            }
        }

        xmlOutputEl.textContent = xmlString;
        downloadButton.disabled = xmlString.startsWith('<!--');
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const modeSelect = document.getElementById('mode-select');
        const downloadButton = document.getElementById('download-button');

        modeSelect.addEventListener('change', (e) => {
            appState.mode = e.target.value;
            render();
        });

        downloadButton.addEventListener('click', () => {
            const blob = new Blob([xmlOutputEl.textContent], { type: 'application/xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mdm.xml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        render(); // Initial render
    });
</script>

</body>
</html>